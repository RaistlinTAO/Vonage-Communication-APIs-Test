<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.1/css/bootstrap.min.css"/>
    <link rel='stylesheet' href='/stylesheets/style.css'/>
    <title>Halfmoon Move Client</title>
    <script src="https://static.opentok.com/v2/js/opentok.js"></script>
</head>
<body>
<div class="container-fluid">
    <div class="alert alert-primary" role="alert">
        Primary Message Area
    </div>
    <div id="videos" class="row">
        <div id="subscribers" class="col-md-4 col-sm-12">
            <div class="card" id="myself">

            </div>
            <div class="card" id="subscriber">

            </div>
        </div>
        <div class="col-md-8 col-sm-12">
            <div class="card" id="publisher">

            </div>
            <div class="card" id="chat">
                <div id="textchat">
                    <p id="history"></p>
                    <form>
                        <input type="text" placeholder="Input your text here" id="msgTxt"></input>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- OpenTok.js library -->
<script src="https://static.opentok.com/v2/js/opentok.js"></script>
<script>
    function handleError(error) {
        if (error) {
            alert(error.message);
        }
    }

    // credentials
    var apiKey = '<%= apiKey %>';
    var sessionId = '<%= sessionId %>';
    var token = '<%= token %>';
    var clientName = '<%= cName %>';

    // connect to session
    var session = OT.initSession(apiKey, sessionId);

    // create publisher
    var publisher = OT.initPublisher('myself', {
        width: '100%',
        height: '100%',
        insertMode: 'append'
    }, handleError);
    session.connect(token, function (error) {
        // publish publisher
        if (error) {
            handleError(error);
        } else {
            session.publish(publisher, handleError);
        }
    });

    // create subscriber
    session.on('streamCreated', function (event) {
        //session.subscribe(event.stream);
        //alert('event.stream.caller' + event.stream.caller);
        //alert('event.stream.name' + event.stream.name);
        //alert('event.stream.id' + event.stream.id);
        if (event.stream.name === 'Tutor') {
            session.subscribe(event.stream, 'publisher', {
                //insertMode: 'append',
                width: '100%',
                height: '100%'
            }, handleError);
        } else {
            session.subscribe(event.stream, 'subscriber', {
                insertMode: 'before',
                width: '100%',
                height: '200',
                type: 'bestFit'
            }, handleError);
        }
    });

    // Receive a message and append it to the history
    var msgHistory = document.querySelector('#history');
    session.on('signal:msg', function signalCallback(event) {
        var msg = document.createElement('p');
        msg.textContent = event.data;
        msg.className = event.from.connectionId === session.connection.connectionId ? 'mine' : 'theirs';
        msgHistory.appendChild(msg);
        msg.scrollIntoView();
    });

    // Text chat
    var form = document.querySelector('form');
    var msgTxt = document.querySelector('#msgTxt');

    // Send a signal once the user enters data in the form
    form.addEventListener('submit', function submit(event) {
        event.preventDefault();

        session.signal({
            type: 'msg',
            data: clientName + ': ' + msgTxt.value
        }, function signalCallback(error) {
            if (error) {
                console.error('Error sending signal:', error.name, error.message);
            } else {
                msgTxt.value = '';
            }
        });
    });

</script>
</body>
</html>
